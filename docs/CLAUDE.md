# Share X 정산 자동화 프로젝트

> **프로젝트 경로**: `/Users/plusx-junsikhwang/Documents/GitHub/ShareX_Settlement`
> **Phase 0**: 완료 (53/53 검증 통과, 2026-02-09)
> **현재 단계**: Phase 1 진입

---

## 1. 프로젝트 개요

**Share X**(쉐어엑스)는 플러스엑스가 패스트캠퍼스 플랫폼을 통해 운영하는 디자인 온라인 강의 사업이다. 12개 유니온 기업(외부 파트너사)이 강의를 제공하고, 매월/매분기 매출에서 마케팅비를 차감한 공헌이익의 일정 비율을 수익쉐어 강사료로 정산한다.

현재 수동 정산 프로세스를 단계적으로 자동화하는 것이 목표이다.

### AS-IS (수동 프로세스)
1. 매월 10일까지 패스트캠퍼스로부터 전월 정산서를 PDF로 수신
2. 유니온 기업별 매출 데이터 분류
3. 광고비를 직접/간접으로 분류, 간접광고비는 강의 수 기준 안분
4. Adriel에서 광고 집행 데이터 다운로드하여 역산
5. 기업별 정산서 작성 및 메일 발송

### TO-BE (자동화 목표)
- **Input**: 정산서(PDF/Excel) + 광고비 인보이스 + Adriel 광고 데이터(CSV/Excel)
- **Process**: 자동 파싱 → 매핑 → 안분 계산 → 교차검증
- **Output**: 웹 URL 기반 기업별 정산서 (PDF 다운로드 가능)

### 최종 산출물 (확정)
1. **로컬 웹앱** — 브라우저에서 기업별 정산 결과를 테이블로 확인/수정, 교차검증 결과 실시간 표시
2. **"확정" 버튼 → 기업별 PDF 일괄 생성** — `/output/YYYY-QN/{기업명}_정산서_{기간}.pdf`
3. **정산메일 본문 자동 생성** — 머지태그 템플릿에 기업별 변수 자동 치환

### 제약 조건
- 플러스엑스 EX팀은 Windows PC, 나머지는 macOS → UTF-8/폰트 호환 필수
- 패스트캠퍼스 광고관리자 접근 권한 없음 → Adriel 데이터로 역산
- 단계별 MVP 방식으로 진행
- 개인정보(담당자, 계좌)는 로컬/Google Sheets에 저장

---

## 2. 프로젝트 구조

```
ShareX_Settlement/
├── data/
│   ├── companies.json          # 13개 기업 마스터 (Phase 0 완료)
│   └── course_mapping.json     # 39개 강의-기업 매핑 (Phase 0 완료)
├── config/
│   ├── campaign_rules.json     # 광고 캠페인 분류 규칙 (Phase 0 완료)
│   └── README.md
├── src/
│   └── apportionment.py        # 안분 계산 엔진 (Phase 0 완료)
├── Share X Settlement_Info.xlsx       # 14개 시트, 기업/프로세스 정보
├── Share X Settlement_Master_2023-2026.xlsx  # 84개 시트, 정산 원본
├── structure_analysis.json            # Master 파일 구조 분석 결과
├── excel_structure_analyzer.py        # Excel 구조 분석 도구
├── validation_phase0.py               # Phase 0 검증 스크립트 (53 checks)
└── CLAUDE.md                          # 이 파일 (프로젝트 지침)
```

---

## 3. 데이터 소스

### 3.1 Master 파일 (84개 시트)

| 시트 유형 | 수량 | 설명 |
|-----------|------|------|
| 정산(실비) | 44개 | 월별 수익쉐어 정산서 (핵심) |
| 광고 | 28개 | Adriel 광고 집행 데이터 |
| 기타/미분류 | 6개 | 임시 작업 시트 |
| 컨퍼런스_제작비 | 2개 | 컨퍼런스 제작비 |
| B2B/재계산/허스키/통합 | 4개 | 기타 |

**정산(실비) 시트 스키마 변형 (8가지):**
- 초기: 매출액 → 마케팅비용 → 공헌이익 → 수익쉐어 강사료(70%)
- 중기: 직접 광고비 + 간접광고비 분리
- 최근: 수익쉐어 비율 70% → 65% → 60% 변경
- 일부 시트에 제작비 컬럼 추가
- 헤더 행 위치: 대부분 20행, 일부 50행

### 3.2 Info 파일 (14개 시트) — 핵심 활용도

| 시트명 | 내용 | 활용도 |
|--------|------|--------|
| 정산 | 13개 기업 마스터 (사업자번호, 계좌, 담당자 등) | ★★★ |
| 정산메일 | 머지태그 기반 메일 템플릿 | ★★★ |
| 정산내역 | 24년 4분기 확정 정산 금액 (11개 기업) | ★★★ |
| 정산서(논리) | 캠페인별 광고비 분류 + 직접/간접 구분 로직 | ★★★ |
| 광고비 사용내역 | 안분 공식 명시 + 매체/캠페인별 세부내역 | ★★★ |
| 정산데이터(Raw) | 2023.01~2025.06 전체 Raw (1,019행, 51개 코스, 12개 기업) | ★★★ |
| 정산데이터(Table) | 기업별 피벗 (매출, 광고비, 공헌이익, 강사료) | ★★★ |
| 광고비(인사이트아웃) | 컨퍼런스 전용 광고비 (디자인하우스) | ★★☆ |
| 유니온LIST | 유니온 기업 파이프라인 | ★★☆ |
| 나머지 5개 | 매출분석, B2B, 관계자LIST, 업무LIST, 시뮬레이션 | ★☆☆ 이하 |

---

## 4. 핵심 데이터 매핑

### 4.1 유니온 기업 (13개)

| 회사명 | company_id | 강의 수 | 유형 |
|--------|-----------|---------|------|
| 플러스엑스 | plusx | 24 | 운영사 |
| 허스키폭스 | huskyfox | 4 | 유니온 |
| BKID | bkid | 2 | 유니온 |
| 코스믹레이 | cosmicray | 1 | 유니온 |
| HEAZ | heaz | 1 | 유니온 |
| 아뜰리에동가 | atelier_dongga | 1 | 유니온 |
| 폰트릭스 | fontrix | 1 | 유니온 |
| 디파이(DFY) | dfy | 1 | 유니온 |
| Compound-C | compound_c | 1 | 유니온 |
| 시싸이드시티 | csidecity | 1 | 유니온 |
| 김형준(BLSN) | blsn | 1 | 유니온 |
| 주식회사 산돌 | sandoll | 1 | 유니온 |
| (주) 디자인하우스 | designhouse | 0 | 유니온(신규, 2025.08~) |

전체 매핑: `data/course_mapping.json` (39개 코스 상세)
기업 상세: `data/companies.json` (사업자번호, 계좌, 연락처 등)

### 4.2 광고 캠페인 분류 체계

| 캠페인 내 광고 대상 | 분류 | 안분 방식 |
|---------------------|------|-----------|
| `SHARE X` | 간접광고비 (통합광고) | 전체 강의 수로 균등 안분 |
| `PLUS X` | 직접광고비 | 플러스엑스에만 귀속 |
| `BKID` | 직접광고비 | BKID에만 귀속 |
| `BLSN` | 직접광고비 | BLSN에만 귀속 |
| `SANDOLL` | 직접광고비 | 산돌에만 귀속 |

캠페인 유형:
- `[Share X] 통합 광고` → 간접광고비 (전체 강의 수로 안분)
- `[기업명] 신규 오픈 광고` → 직접광고비 (해당 기업 귀속)
- `[Share X] 컨퍼런스 광고` → 컨퍼런스 별도 정산 (디자인하우스)

광고 채널: Google, Meta, Naver, Pinterest
상세 규칙: `config/campaign_rules.json`

---

## 5. 안분 로직

### 5.1 핵심 공식

```
간접광고비 안분 = 총 간접광고비 ÷ 전체 강의 수 × 해당 기업 강의 수
```

### 5.2 계산 플로우

```
1. 입력 데이터 수집
   ├── 정산서 → 강의별 매출액
   ├── 인보이스 → 캠페인별 광고비 (KRW)
   └── Adriel CSV → 캠페인별 세부 집행 데이터

2. 광고비 분류
   ├── 캠페인명 파싱 → 광고 대상(SHARE X / 기업명) 추출
   ├── 직접광고비: 특정 기업 대상 → 100% 귀속
   └── 간접광고비: SHARE X 대상 → 전체 강의 수로 안분

3. 기업별 안분 계산
   ├── Case 1: 단독 제공 → 직접광고비 100% + 간접광고비 안분액
   ├── Case 2: 공동 제공 (균등) → 50:50 분할
   ├── Case 3: 공동 제공 (비대칭) → 매핑 테이블 커스텀 비율
   └── Case 4: 정산 제외 → 직접광고비 0, 간접광고비 분모에서도 제외

4. 정산 금액 계산
   ├── 공헌이익 = 매출액 - 직접광고비 - 간접광고비
   ├── 수익쉐어 강사료 = 공헌이익 × 75% (현재 기준)
   └── 유니온 실지급 = 수익쉐어 강사료 × (유니온 비율)

5. 교차검증
   ├── Σ(기업별 마케팅비) = 원본 전체 마케팅비 (±1원 허용)
   ├── 모든 코스ID ⊆ 매핑 테이블 (누락 0건)
   ├── 각 강의별 Σ(안분비율) = 100%
   ├── |당월 - 전월| / 전월 > 30% → 경고 플래그
   └── 자동계산 vs 확정 정산서 비교
```

### 5.3 환율 처리

Meta 광고는 USD로 집행, 월별 적용환율로 KRW 변환:

| 월 | 환율 (원/USD) |
|----|--------------|
| 2024.10 | 1,361.00 |
| 2024.11 | 1,393.38 |
| 2024.12 | 1,434.42 |
| 2025.01 | 1,455.79 |
| 2025.02 | 1,445.56 |
| 2025.03 | 1,456.95 |

### 5.4 수익쉐어 비율

- Info 파일 기준: 공헌이익 대비 **75%** (모든 기업 동일)
- Master 파일에서 시기별 변동 관찰: 70% → 65% → 60% (변경 시점 확인 필요)
- 유니온 실지급 강사료는 약 2/3 수준 (플엑 몫 제외)

### 5.5 전체 강의 수

- 정산서(논리) 기준: 플엑 24개 + 유니온 15개 = **39개**
- 시기에 따라 38~40개 변동 → 매핑 테이블에서 활성 강의 수 관리

---

## 6. 검증 데이터 (24년 4분기 확정)

| 기업명 | 정산 금액 |
|--------|-----------|
| 허스키폭스 | 6,432,849.5원 |
| 코스믹레이 | 4,083,126.5원 |
| BKID | 4,509,514.5원 |
| HEAZ | 3,659,120.0원 |
| 아뜰리에동가 | 2,392,750.5원 |
| 폰트릭스 | 949,759.0원 |
| 디파이 | 2,994,788.5원 |
| Compound-C | 2,255,400.0원 |
| 시싸이드시티 | 1,930,270.5원 |
| 김형준 | 1,031,299.0원 |
| 주식회사 산돌 | 2,469,468.5원 |
| **합계** | **32,708,346.5원** |

Phase 1 완료 기준: 자동계산 결과가 위 확정 금액과 **±1원 이내 일치**

---

## 7. 정산메일 템플릿

**제목**: `[플러스엑스-{Company}] 쉐어엑스 24년 4분기 정산서`

**본문 머지태그**:
- `{Company}` → 기업명
- `{Name}` → 담당자명 + 호칭
- `{Content}` → 정산 내용 (예: "허스키폭스_쉐어엑스 강사료_4Q/2024")
- `{Amount}` → 정산 금액 (VAT 포함)
- `{Bank}` → 계좌번호
- `{File}` → 정산서 다운로드 링크

---

## 8. 로드맵

### Phase 0: 데이터 정규화 & 매핑 테이블 확정 — 완료

| 산출물 | 상태 | 검증 |
|--------|------|------|
| `data/companies.json` (13개 기업) | 완료 | 9/9 통과 |
| `data/course_mapping.json` (39개 코스) | 완료 | 15/15 통과 |
| `config/campaign_rules.json` (캠페인 규칙) | 완료 | 13/13 통과 |
| `src/apportionment.py` (안분 엔진) | 완료 | 13/13 통과 |
| 정산 금액 검증 | 완료 | 3/3 통과 |
| **전체** | **완료** | **53/53 통과 (100%)** |

검증 스크립트: `python3 validation_phase0.py`

### Phase 1: 파서 & 계산 엔진 MVP (현재 단계)

**목표**: 입력 파일을 자동 파싱하고, 안분 계산 후 교차검증까지 수행

**작업 내용**:
1. **Master 정산서 파서** — 8가지 스키마 변형 자동 대응, 동적 헤더 감지 + 데이터 타입 정규화
2. **광고비 데이터 파서** — 캠페인명에서 기업코드 자동 추출, 직접/간접 자동 분류
3. **안분 계산 엔진** — Phase 0 공식을 전체 데이터에 적용, 기업별 정산 금액 산출
4. **교차검증 모듈** — 24년 4분기 확정 데이터와 비교, 5종 검증 + 리포트 자동 생성

**완료 기준**: 24년 4분기 자동계산 → 확정 금액과 ±1원 이내 일치

**Phase 1 진입 시 주의사항** (Phase 0 검증에서 도출):
- 이메일 필드에 콤마 구분 복수 수신자 존재 → 파싱 로직 필요
- designhouse는 "신규" 기업, 시작일 2025-08-08 → Q4 2024 정산 대상 아님
- 수익쉐어 비율은 기간별 변동 (70%, 65%, 60%) → 엔진에서 파라미터화
- 환율은 월별 적용 → 정산월 기준 환율 조회 구현

### Phase 2: 웹 확인/수정 → PDF + 메일 생성

**목표**: 웹에서 기업별 정산 결과 확인/수정 → 확정 후 PDF + 정산메일 일괄 생성

**작업 내용**:
1. **웹 정산 확인/수정 화면** — Phase 1 결과를 웹 테이블로 표시, 수동 수정 가능, 수정 시 교차검증 자동 재실행
2. **"확정" → PDF 일괄 생성** — `/output/YYYY-QN/` 폴더에 기업별 PDF 생성, Win/Mac 호환 폰트
3. **정산메일 자동 생성** — 머지태그 치환, 메일 제목+본문 출력
4. **검증 리포트** — 확정 시점 교차검증 결과 저장, 전분기 대비 변동 요약

---

## 9. 기술 스택

```
데이터 처리:  Python 3.x (pandas, openpyxl)
안분 엔진:   Python
매핑 테이블:  로컬 JSON (Google Sheets API 확장 가능)
웹 정산서:   React + Tailwind CSS
PDF 생성:   Puppeteer 또는 react-pdf
서버:       Flask/FastAPI (로컬)
인코딩:     UTF-8 강제 (Win/Mac 호환)
폰트:       Pretendard (크로스플랫폼)
```

---

## 10. 데이터 품질 이슈 (전처리 시 대응 필요)

1. **헤더 행 위치 불일치**: 정산(실비) 시트 20행 또는 50행
2. **날짜 형식 혼재**: datetime 객체 vs 텍스트 ("2024. 3Q")
3. **0값 표현**: "-" 문자열 → 0으로 변환
4. **병합 셀**: pandas에서 NaN → ffill 필요
5. **메타데이터 행**: 1~18행에 회사 정보 → skiprows
6. **숫자 문자열**: 콤마, ₩, % 포함 → 정규식 제거 후 숫자 변환
7. **인코딩**: \xa0 (non-breaking space), \u202d/\u202c (방향 제어 문자)

---

## 11. 미확인 사항

1. 수익쉐어 비율이 기업마다 다른가, 전체 동일한가?
2. Master(70%/65%/60%)와 Info(75%)의 계산 기준 차이? (매출 대비 vs 공헌이익 대비)
3. 복수 기업 공동 제공 강의 실제 케이스?
4. 정산 제외 강의 기준?
5. 컨퍼런스 광고비(인사이트아웃)는 디자인하우스 전용 별도 정산인가?

---

## 12. 이미 구축된 도구

| 도구 | 위치 | 용도 |
|------|------|------|
| excel_structure_analyzer.py | 프로젝트 루트 | Excel 시트 자동 분석, 헤더 감지, 타입 추론 |
| structure_analysis.json | 프로젝트 루트 | Master 84개 시트 구조 분석 결과 |
| validation_phase0.py | 프로젝트 루트 | Phase 0 검증 (53 checks) |
| extract_campaign_rules.py | 프로젝트 루트 | 캠페인 분류 규칙 추출 |
| settlement_automation_proposal.jsx | 프로젝트 루트 | 정산 자동화 제안서 (React 컴포넌트) |
